<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Chat Anónimo IbericaRP</title>
  <style>
    body {
      font-family: monospace;
      background-color: black;
      color: #66ff66;
      padding: 20px;
      overflow: hidden;
      margin: 0;
    }
    #matrix {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      z-index: 0;
    }
    #chat {
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid #0f0;
      padding: 10px;
      margin-bottom: 10px;
      background: #000;
      position: relative;
      z-index: 1;
    }
    .message {
      margin-bottom: 8px;
    }
    .msg-user {
      color: #66ff66;
    }
    .msg-other {
      color: #00ffff;
    }
    #messageInput {
      width: 80%;
      padding: 10px;
      background: #222;
      border: 1px solid #0f0;
      color: #66ff66;
      position: relative;
      z-index: 1;
    }
    #sendBtn {
      padding: 10px 15px;
      background: #0f0;
      border: none;
      cursor: pointer;
      color: black;
      font-weight: bold;
      position: relative;
      z-index: 1;
    }
  </style>
</head>
<body>

<canvas id="matrix"></canvas>

<h2 style="position: relative; z-index: 1;">Chat Anónimo IbericaRP</h2>
<div id="chat"></div>

<input type="text" id="messageInput" placeholder="Escribe tu mensaje..." autocomplete="off" />
<button id="sendBtn">Enviar</button>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
  // Efecto Matrix en Canvas
  const canvas = document.getElementById('matrix');
  const ctx = canvas.getContext('2d');
  canvas.height = window.innerHeight;
  canvas.width = window.innerWidth;

  let letters = "01ABCDEFGHIJKLMNOPQRSTUVWXYZ$%#@*".split("");
  let fontSize = 14;
  let columns = canvas.width / fontSize;
  let drops = Array(Math.floor(columns)).fill(1);

  function drawMatrix() {
    ctx.fillStyle = "rgba(0, 0, 0, 0.05)";
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = "#0F0";
    ctx.font = fontSize + "px monospace";

    for (let i = 0; i < drops.length; i++) {
      let text = letters[Math.floor(Math.random() * letters.length)];
      ctx.fillText(text, i * fontSize, drops[i] * fontSize);
      if (drops[i] * fontSize > canvas.height && Math.random() > 0.975) drops[i] = 0;
      drops[i]++;
    }
  }
  setInterval(drawMatrix, 33);

  // Config Firebase (con databaseURL correcto)
  const firebaseConfig = {
    apiKey: "AIzaSyAAihYPChiJC61hazahxbHKgv384UE9HUU",
    authDomain: "ibericachatdrknt.firebaseapp.com",
    databaseURL: "https://ibericachatdrknt-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "ibericachatdrknt",
    storageBucket: "ibericachatdrknt.appspot.com",
    messagingSenderId: "933093011275",
    appId: "1:933093011275:web:645bd6ea82dcc022fc02ce",
    measurementId: "G-D0RNWWQXLS"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // Clave maestra para desbanear
  const masterPassword = "claveSecreta123"; // Cambia esta clave a la que quieras

  // Admins fijos
  const admins = ['Anon4397', 'Anon7919'];

  // Cargar baneados, timeouts y contador de timeouts de localStorage o crear objetos vacíos
  let bannedUsers = JSON.parse(localStorage.getItem('bannedUsers')) || {};
  let timeoutUsers = JSON.parse(localStorage.getItem('timeoutUsers')) || {};
  let timeoutCount = JSON.parse(localStorage.getItem('timeoutCount')) || {};

  // Obtener o crear usuario
  let username = localStorage.getItem('anonUser');
  if (!username) {
    username = 'Anon' + Math.floor(Math.random() * 9000 + 1000);
    localStorage.setItem('anonUser', username);
  }

  const chatDiv = document.getElementById('chat');
  const input = document.getElementById('messageInput');
  const sendBtn = document.getElementById('sendBtn');

  // Mostrar mensaje en chat
  function mostrarMensaje(user, text) {
    const div = document.createElement('div');
    div.classList.add('message');
    div.innerHTML = `<span class="${user === username ? 'msg-user' : 'msg-other'}">${user}:</span> ${text}`;
    chatDiv.appendChild(div);
    chatDiv.scrollTop = chatDiv.scrollHeight;
  }

  // Descargar fichero de texto
  function descargarTexto(filename, text) {
    const element = document.createElement('a');
    element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
    element.setAttribute('download', filename);
    element.style.display = 'none';
    document.body.appendChild(element);
    element.click();
    document.body.removeChild(element);
  }

  // Guardar baneados, timeouts y contador en localStorage
  function guardarBaneados() {
    localStorage.setItem('bannedUsers', JSON.stringify(bannedUsers));
  }
  function guardarTimeouts() {
    localStorage.setItem('timeoutUsers', JSON.stringify(timeoutUsers));
  }
  function guardarTimeoutCount() {
    localStorage.setItem('timeoutCount', JSON.stringify(timeoutCount));
  }

  // Comprobar si usuario está baneado
  function estaBaneado(user) {
    return bannedUsers.hasOwnProperty(user);
  }

  // Comprobar si usuario está en timeout y si el timeout expiró
  function estaEnTimeout(user) {
    if (!timeoutUsers.hasOwnProperty(user)) return false;
    const timeoutEnd = timeoutUsers[user];
    if (Date.now() > timeoutEnd) {
      delete timeoutUsers[user];
      guardarTimeouts();
      return false;
    }
    return true;
  }

  // Añadir timeout a usuario (1 minuto). Si llega a 5 timeouts, se banea indefinidamente
  function ponerTimeout(user) {
    if (!timeoutCount[user]) timeoutCount[user] = 0;
    timeoutCount[user]++;
    guardarTimeoutCount();

    if (timeoutCount[user] >= 5) {
      bannedUsers[user] = 'Has superado el máximo de timeouts (5)';
      guardarBaneados();
      alert(`Usuario ${user} baneado indefinidamente por exceder timeouts.`);
    } else {
      const now = Date.now();
      timeoutUsers[user] = now + 60000; // 1 minuto
      guardarTimeouts();
      alert(`Timeout puesto a ${user}. (${timeoutCount[user]} de 5)`);
    }
  }

  // Obtener lista de usuarios únicos desde Firebase
  async function obtenerUsuarios() {
    const snapshot = await db.ref('mensajes').once('value');
    const data = snapshot.val() || {};
    const usuariosSet = new Set();
    for (const key in data) {
      if (data.hasOwnProperty(key)) {
        usuariosSet.add(data[key].user);
      }
    }
    return Array.from(usuariosSet);
  }

  // Procesar comandos (solo admins)
  async function procesarComando(text) {
    const partes = text.trim().split(' ');
    const comando = partes[0].toLowerCase();
    const argumento = partes[1];
    const razon = partes.slice(2).join(' ') || 'Sin razón';

    if (!admins.includes(username)) {
      alert('No tienes permisos para usar comandos.');
      return true;
    }

    if (comando === '!t1meout') {
      if (!argumento) {
        alert('Debes indicar un usuario para poner timeout.');
        return true;
      }
      if (admins.includes(argumento)) {
        alert('No puedes poner timeout a un administrador.');
        return true;
      }
      ponerTimeout(argumento);
      return true;
    }

    if (comando === '!unt1meout') {
      if (!argumento) {
        alert('Debes indicar un usuario para quitar timeout.');
        return true;
      }
      if (timeoutUsers.hasOwnProperty(argumento)) {
        delete timeoutUsers[argumento];
        guardarTimeouts();
        alert(`Timeout quitado a ${argumento}`);
      } else {
        alert('El usuario no está en timeout.');
      }
      return true;
    }

    if (comando === '!list4time') {
      let texto = 'Usuarios en timeout:\n\n';
      for (const user in timeoutUsers) {
        const remaining = Math.max(0, Math.floor((timeoutUsers[user] - Date.now()) / 1000));
        texto += `${user} - Tiempo restante: ${remaining} segundos\n`;
      }
      if (texto === 'Usuarios en timeout:\n\n') texto += 'No hay usuarios en timeout.';
      descargarTexto('usuarios_timeout.txt', texto);
      return true;
    }

    if (comando === '!list4users') {
      const usuarios = await obtenerUsuarios();
      let texto = 'Usuarios que se han conectado:\n\n';
      usuarios.forEach(u => texto += u + '\n');
      if (usuarios.length === 0) texto += 'No hay usuarios registrados.';
      descargarTexto('usuarios_conectados.txt', texto);
      return true;
    }

    return false;
  }

  // Palabras prohibidas (ejemplos en español con tilde y sin)
const bannedWords = [
  'puta', 'putá', 'puto', 'putó', 'putos', 'putós', 'putas', 'putás',
  'mierda', 'mierdá',
  'coño', 'coño', // sin tilde es raro, pero lo dejo igual
  'gilipollas',
  'joder',
  'cabron', 'cabrón',
  'cabrona',
  'cabrones', 'cabrónes',
  'culo',
  'polla',
  'pene',
  'verga',
  'chingar',
  'chingado', 'chingadó',
  'chingada', 'chingáda',
  'chingados', 'chingádos',
  'chingonas', 'chingónas',
  'chingón', 'chingon',
  'hostia',
  'zorra',
  'tonto',
  'tonta',
  'imbecil',
  'idiota',
  'subnormal',
  'bastardo',
  'estupido', 'estúpido',
  'pendejo',
  'pendeja',
  'tarado',
  'tarada',
  'maldito',
  'maldita',
  'puta madre',
  'hijo de puta',
  'pinche',
  'carajo',
  'maricón', 'maricon',
  'maricona',
  'mariconez',
  'pedo',
  'pedocha',
  'mamón', 'mamon',
  'puta que te parió', 'puta que te pario',
  'me cago en',
  'me cago en todo',
  'la concha de tu madre',
  'cojones',
  'puta mierda',
  'mierda de mierda',
  'facha',
  'nazi',
  'racista',
  'homofobo', 'homófobo',
  'terrorista',
  'cabronazo',
  'chinga tu madre',
  'malparido',
  'malparida',
  'chupapollas',
  'pajero',
  'pajera',
  'cerdo',
  'cerda',
  'bicho raro',
  'puta de mierda'
];

  // Función para pedir clave y desbanear
  function pedirClaveDesban() {
    const clave = prompt('Estás baneado. Introduce la clave para desbanearte:');
    if (clave === null) return false; // Canceló
    if (clave === masterPassword) {
      delete bannedUsers[username];
      guardarBaneados();
      alert('Clave correcta. Has sido desbaneado.');
      return true;
    } else {
      alert('Clave incorrecta. Sigues baneado.');
      return false;
    }
  }

  // Enviar mensaje
  async function enviarMensaje() {
    const text = input.value.trim();
    if (text === '') return;

    if (estaBaneado(username)) {
      const desbaneado = pedirClaveDesban();
      if (!desbaneado) {
        input.value = '';
        return;
      }
    }

    if (estaEnTimeout(username)) {
      alert('Estás en timeout. Espera 1 minuto antes de enviar otro mensaje.');
      input.value = '';
      return;
    }

    if (text.startsWith('!')) {
      const comandoProcesado = await procesarComando(text);
      if (comandoProcesado) {
        input.value = '';
        return;
      }
    }

    // Comprobar palabras prohibidas
    const textoMinuscula = text.toLowerCase();
    for (const palabra of bannedWords) {
      if (textoMinuscula.includes(palabra)) {
        alert('Mensaje contiene palabra prohibida. Se te pone timeout 1 minuto.');
        ponerTimeout(username);
        input.value = '';
        return;
      }
    }

    db.ref('mensajes').push({
      user: username,
      text: text
    });

    input.value = '';
  }

  // Escuchar nuevos mensajes
  db.ref('mensajes').on('child_added', snapshot => {
    const msg = snapshot.val();
    if (estaBaneado(msg.user)) return;
    if (estaEnTimeout(msg.user)) return; // No mostrar mensajes de usuarios en timeout
    if (msg.text.startsWith('!')) return;
    mostrarMensaje(msg.user, msg.text);
  });

  sendBtn.addEventListener('click', enviarMensaje);
  input.addEventListener('keypress', e => {
    if (e.key === 'Enter') enviarMensaje();
  });

  // Al cargar la página, si el usuario está baneado, avisar y pedir clave
  if (estaBaneado(username)) {
    const desbaneado = pedirClaveDesban();
    if (!desbaneado) {
      alert('No podrás enviar mensajes hasta que te desbanees.');
    }
  }
</script>

</body>
</html>
